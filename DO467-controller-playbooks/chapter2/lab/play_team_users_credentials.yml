- name: Tower Team Users Role Playbook
  hosts: localhost
  gather_facts: no
  vars_files:
  - vars_users.yml

  tasks:
  # - name: Run Lab script
  #   import_tasks: lab_script.yml

  - name: Create teams in tower
    ansible.controller.team:
      name: "Operations"
      description: "Ops Team"
      organization: "Default"
      state: "present"
      controller_config_file: "./controller_cli.cfg"

  # - name: Add Team via command Line
  #   shell: >
  #           tower-cli team create
  #           --name "Operations" --organization "Default" --description "Ops Team"
  #           --tower-host "tower.lab.example.com" --tower-username "admin"
  #           --tower-password "redhat" --insecure
  #           

  - name: Create user via tower_user module
    ansible.controller.user:
      username: "{{ item.username }}"
      password: "{{ item.password }}"
      email: "{{ item.email }}"
      first_name: "{{ item.first_name }}"
      last_name: "{{ item.last_name }}"
      state: "{{ item.state  }}"
      controller_config_file: "./controller_cli.cfg"
    loop: "{{ users_info }}"

   

  - name: Add users to appropriate team via tower_role
    ansible.controller.role:
      user: "{{ item.name }}"
      target_team: "{{ item.team }}"
      role: "{{ item.role }}"
      state: "{{ item.state }}"
      controller_config_file: "./controller_cli.cfg"
    loop: "{{ users_team_association_info }}"


  #- name: Assign user role via tower_cli command
  #  shell: > 
  #          tower-cli role grant --user 'ophelia' 
  #          --target-team 'Operations' --type ''admin''
  #          --tower-host "tower.lab.example.com" --tower-username "admin" 
  #          --tower-password "redhat" --insecure

  - name: Create Group
    infra.ah_configuration.ah_group:
      name: "{{ item }}"
      state: present
      ah_host: https://hub.lab.example.com
      ah_username: admin
      ah_password: redhat
      validate_certs: false
    loop: "{{ hub_groups }}"

  - name: Create User
    infra.ah_configuration.ah_user:
      username: "{{ item.user_name }}"
      first_name: "{{ item.first_name }}"
      last_name: "{{ item.last_name }}"
      email: "{{ item.user_email }}"
      password: "{{ item.password }}"
      is_superuser: "{{ item.superuser }}"
      groups: "{{ item.groups | default(null) }}"
      state: present
      ah_host: https://hub.lab.example.com
      ah_username: admin
      ah_password: redhat
      validate_certs: false
    loop: "{{ hub_users }}"
